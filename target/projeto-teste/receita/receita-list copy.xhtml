<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:p="http://primefaces.org/ui"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    template="/templates/template.xhtml">

    <ui:define name="titulo">Receitas Médicas</ui:define>

    <ui:define name="conteudo">
        <h:form id="formReceita">
            <p:messages autoUpdate="true" closable="true" />

            <p:panel header="Cadastro de Receitas">

                <!-- Botão Novo -->
                <p:toolbar>
                    <p:toolbarGroup>
                        <p:commandButton value="Nova Receita"
                                        icon="pi pi-plus"
                                        action="#{receitaBean.novo}"
                                        update=":formReceita"
                                        process="@this"
                                        oncomplete="PF('dlgReceita').show();"
                                        styleClass="p-button-success" />
                    </p:toolbarGroup>
                    

                </p:toolbar>

                <!-- Dialog de Nova Receita -->
                <!-- Dialog de Nova Receita -->
                <p:dialog id="dlgReceita"
                        widgetVar="dlgReceita"
                        header="Nova Receita"
                        modal="true"
                        width="650"
                        resizable="false">

                    <!-- Painel principal -->
                    <p:panel header="Dados da Receita" style="margin-bottom:10px">
                        <p:panelGrid columns="2" columnClasses="label,value" style="width:100%" cellpadding="5">
                            
                            <!-- Paciente -->
                            <p:outputLabel for="paciente" value="Paciente:" style="width:120px" />
                            <p:autoComplete id="paciente"
                                            value="#{receitaBean.receita.paciente}"
                                            completeMethod="#{receitaBean.buscarPacientes}"
                                            var="p"
                                            itemLabel="#{p.nome}"
                                            itemValue="#{p}"
                                            converter="pacienteConverter"
                                            forceSelection="true"
                                            dropdown="true"
                                            placeholder="Digite o nome do paciente..."
                                            minQueryLength="2"
                                            cache="false"
                                            scrollHeight="300"
                                            style="width:100%" />

                            
                            <h:panelGrid columns="2" cellpadding="0" cellspacing="0" style="width:100%">
                                <!-- Medicamento -->
                                <p:outputLabel for="medicamento" value="Medicamento:" style="width:120px" />
                                <p:autoComplete id="medicamento"
                                                value="#{receitaBean.novoItem.medicamento}"
                                                completeMethod="#{receitaBean.buscarMedicamentos}"
                                                var="m"
                                                itemLabel="#{m.nome}"
                                                itemValue="#{m}"
                                                converter="medicamentoConverter"
                                                forceSelection="true"
                                                dropdown="true"
                                                placeholder="Digite o medicamento..."
                                                minQueryLength="2"
                                                cache="false"
                                                scrollHeight="300"
                                                style="width:100%" />

                                <p:commandButton value="Adicionar"
                                                icon="pi pi-plus"
                                                action="#{receitaBean.adicionarItem}"
                                                update="itensReceita"
                                                process="@form"
                                                styleClass="p-button-outlined p-button-info"
                                                style="margin-left:5px; white-space:nowrap" />
                            </h:panelGrid>
                        </p:panelGrid>
                    </p:panel>

                    <!-- Itens adicionados -->
                    <p:panel header="Medicamentos Adicionados" style="margin-bottom:10px">
                        <p:dataTable id="itensReceita"
                                    value="#{receitaBean.receita.itens}"
                                    var="item"
                                    emptyMessage="Nenhum medicamento adicionado"
                                    style="width:100%">

                            <p:column headerText="Medicamento">
                                <h:outputText value="#{item.medicamento.nome}" />
                            </p:column>

                            <p:column style="width:60px; text-align:center;">
                                <p:commandButton icon="pi pi-trash"
                                                action="#{receitaBean.removerItem(item)}"
                                                update="itensReceita"
                                                title="Remover"
                                                styleClass="p-button-danger p-button-rounded p-button-sm" />
                            </p:column>
                        </p:dataTable>
                    </p:panel>

                    <!-- Botões de ação -->
                    <p:separator style="margin:10px 0" />
                    <h:panelGrid columns="2" style="width:100%; text-align:right;" columnClasses="col,col">
                        <p:commandButton value="Salvar Receita"
                                        icon="pi pi-check"
                                        action="#{receitaBean.salvar}"
                                        update="tabelaReceitas"
                                        oncomplete="if(!args.validationFailed) PF('dlgReceita').hide();"
                                        styleClass="p-button-success" />

                        <p:commandButton value="Cancelar"
                                        icon="pi pi-times"
                                        onclick="PF('dlgReceita').hide(); return false;"
                                        styleClass="p-button-secondary" />
                    </h:panelGrid>
                </p:dialog>




                <!-- Lista de Receitas -->
                <p:dataTable id="tabelaReceitas"
                             value="#{receitaBean.receitas}"
                             var="r"
                             paginator="true"
                             rows="10"
                             paginatorPosition="bottom"
                             rowsPerPageTemplate="10,20,50"
                             emptyMessage="Nenhuma receita cadastrada.">

                    <p:column headerText="Paciente" sortBy="#{r.paciente.nome}">
                        <h:outputText value="#{r.paciente.nome}" />
                    </p:column>

                    <p:column headerText="Data Prescrição" sortBy="#{r.dataPrescricao}">
                        <h:outputText value="#{r.dataPrescricao}" converter="localDateConverter" />
                        
                    </p:column>

                    <p:column headerText="Medicamentos">
                        <ui:repeat value="#{r.itens}" var="i">
                            <h:outputText value="#{i.medicamento.nome}" /><br/>
                        </ui:repeat>
                    </p:column>

                    <p:column headerText="Qtd Medicamentos">
                        <h:outputText value="#{r.itens.size()}" />
                    </p:column>

                </p:dataTable>

            </p:panel>
        </h:form>
    </ui:define>
</ui:composition>





